# mongodb-cluster-on-digitalocean
Deploy Mongo DB cluster on Digital Ocean Cloud

MongoDB Cluster Deployment on DigitalOcean with Terraform and Ansible
=====================================================================

This project automates the deployment of a MongoDB cluster on DigitalOcean using Terraform and Ansible. Terraform is used for provisioning the infrastructure (Droplets), while Ansible configures the MongoDB cluster on the provisioned Droplets. A MongoDB Replica Set is configured with three nodes (1 primary node and 2 secondary nodes).

Prerequisites
-------------

-   A DigitalOcean account (with an API token and public SSH key loaded)
-   [Terraform](https://www.terraform.io/downloads.html) installed
-   [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) installed
-   [Git](https://git-scm.com/downloads) installed

Quick Start
-----------

1.  Clone this repository:

```
git clone https://github.com/gcalcaterra/mongodb-cluster-on-digitalocean
cd mongodb-cluster-on-digitalocean
```

2.  Initialize Terraform:

```
terraform init
```

3.  Create a `terraform.tfvars` file in the project root directory with your DigitalOcean API token and any other required variables:

About the do_token:
Generate one DO token, see [How to Create a Personal Access Token](https://docs.digitalocean.com/reference/api/create-personal-access-token/)

About the the ssh_key_fingerprint var:
This will be the ssh key that ansible will use to connect (and you can use to connect to the machines).
First add your public SSH key to your Digital Ocean account. See [How to Upload SSH Public Keys to a DigitalOcean Team](https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-team/).
Gather the Fingerprint from the DigitalOcean web or use this command from your terminal (dont't use the MD5: in the var):
```
sh-keygen -E md5 -lf ~/path/to/your/ssh_key.pub | awk '{print $2}'
```

```
   do_token = "your_digitalocean_api_token"
   ssh_key_fingerprint = "your_ssh_key_fingerprint" 
```

For example:
```
   do_token = "dop_v1_a63d8370a557a5185833587f34bbed1e90c1970ac7ab254aa762d5d875daed65"
   ssh_key_fingerprint = "22:23:4c:46:16:5a:2d:11:c3:56:fb:87:9a:59:a4:cf"
```


4.  Apply the Terraform configuration to provision the infrastructure on DigitalOcean:

```
terraform apply
```

5.  Install the Ansible MongoDB collections
```
ansible-galaxy collections install -r collections/requirements.yml
```

6.  Run the Ansible playbook to configure the MongoDB cluster (inventory is autogenerated from terraform output):

Password for the admin password (mongodb_admin_password var) must be set and the recommended way would be to use ansible vault.

[Protecting sensitive data with Ansible vault](https://docs.ansible.com/ansible/latest/vault_guide/index.html)

```
ansible-playbook mongodb_cluster.yml 
```

Another (dirty) way can be to specify mongodb_admin_password when running the playbook:
```
ansible-plabyook mongodb_cluster.yml -e "mongodb_admin_password=MyNewPassword"
```

7.  Access your MongoDB cluster and enjoy!
You can test the connection to the MongoDB and test the Replica Set by connecting to the primary node and requesting some info. Here's an example:

```
ssh `grep -v mongodb inventory.ini | awk '{print $2}' | awk -F= '{print $2}' | head -n1`
mongosh --username admin --password MongoDBChangeMe
rs.status()
```

Terraform Configuration
-----------------------

The `main.tf` file contains the Terraform configuration for provisioning the infrastructure required for the MongoDB cluster on DigitalOcean. You'll need to create a `terraform.tfvars` file in the project root directory to set your DigitalOcean API token and any other required variables.

Example `terraform.tfvars`:

```
do_token = "your_digitalocean_api_token"

```

Ansible Configuration
---------------------

The `playbook.yml` file contains the main Ansible playbook for configuring the MongoDB cluster. The `collections` directory contains a requirements.yml that is needed to install the collections that Ansible use for installing and configuring MongoDB. Run the next command to install the collections:
```
ansible-galaxy collection install -r collections/requirements.yml
```

The inventory.ini is generated from terraform output. You can also include any additional configuration options, such as the username and password for the MongoDB admin user.

Customization
-------------

You can customize the deployment by modifying the Terraform and Ansible configuration files as needed. For example, you can adjust the number of MongoDB instances, the instance types, or the MongoDB version.

Contributing
------------

Contributions are welcome!

License
-------

This project is licensed under the [MIT License](https://opensource.org/license/mit/).
